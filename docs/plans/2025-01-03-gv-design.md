# gv - Terminal UI Diff Viewer for Agentic Workflows

## Purpose

A read-only terminal UI for reviewing code changes across multiple git worktrees. Primary use case: monitoring multiple AI agents working in parallel, each in their own worktree or branch.

## Tech Stack

- **TUI**: [Bubble Tea](https://github.com/charmbracelet/bubbletea) + [Lip Gloss](https://github.com/charmbracelet/lipgloss)
- **Git**: [go-git](https://github.com/go-git/go-git)
- **Syntax Highlighting**: [Chroma](https://github.com/alecthomas/chroma)
- **Fuzzy Finding**: [go-fuzzyfinder](https://github.com/ktr0731/go-fuzzyfinder) or bubble tea's built-in

## Core Views

### 1. Main Diff View (Primary)

Full-screen side-by-side diff showing all changes between current branch and main. Code is the focus.

```
┌─────────────────────────────────────────────────────────────────┐
│ gv: feature-auth → main                    [3 commits] +142 -12 │
├───────────────────────────────┬─────────────────────────────────┤
│ src/auth/handler.go      +98  │ src/auth/handler.go        +98  │
├───────────────────────────────┼─────────────────────────────────┤
│                               │ package auth                    │
│                               │                                 │
│                               │ func HandleLogin(w http.Resp... │
│                               │     token, err := generateJWT() │
│                               │     if err != nil {             │
│                               │         http.Error(w, err...    │
│                               │     }                           │
├───────────────────────────────┴─────────────────────────────────┤
│ src/auth/middleware.go   +44 -12                                │
├───────────────────────────────┬─────────────────────────────────┤
│ func oldMiddleware() {        │ func AuthMiddleware() {         │
│     // legacy check           │     token := r.Header.Get(...)  │
│ }                             │ }                               │
├─────────────────────────────────────────────────────────────────┤
│ j/k: scroll  c: commits  w: worktrees  u: unified  q: quit      │
└─────────────────────────────────────────────────────────────────┘
```

**Behaviors:**
- All files expanded by default, scroll through entire diff
- Files collapsible (toggle with Enter on file header)
- Side-by-side default, toggle to unified with `u`
- Syntax highlighted

### 2. Commit Filter Popup

Filter which commits are included in the diff. Default: all commits (full branch diff).

```
┌─ Commits (space: toggle, a: all, n: none) ─┐
│ [x] abc123 Add user authentication endpoint │
│ [x] def456 Add session storage              │
│ [ ] 789abc Fix token expiry bug             │
│                                             │
│ Showing: 2 of 3 commits                     │
└─────────────────────────────────────────────┘
```

### 3. Worktree Switcher (Fuzzy Finder)

Quick switch between worktrees. Invoked with `w`.

```
┌─ Switch Worktree ─────────────────┐
│ > auth                            │
│                                   │
│   feature-auth    ~/git/proj-auth │
│   feature-api     ~/git/proj-api  │
└───────────────────────────────────┘
```

### 4. Worktree List View

Full list of worktrees. Invoked with `W`.

## Keybindings

### Global
| Key | Action |
|-----|--------|
| `j/k` or `↑/↓` | Scroll diff |
| `ctrl+d/u` | Page down/up |
| `g/G` | Top/bottom |
| `n/N` | Next/prev file |
| `q` | Quit |
| `?` | Help |

### View Toggles
| Key | Action |
|-----|--------|
| `u` | Toggle unified/side-by-side |
| `c` | Commit filter popup |
| `w` | Worktree switcher |
| `W` | Worktree list |
| `Enter` | Collapse/expand file |
| `z` | Collapse/expand all |

### Commit Filter
| Key | Action |
|-----|--------|
| `j/k` | Navigate |
| `space` | Toggle commit |
| `a/n` | All/none |
| `Enter/Esc` | Apply & close |

### Worktree Switcher
| Key | Action |
|-----|--------|
| Type | Fuzzy filter |
| `j/k` | Navigate |
| `Enter` | Switch |
| `Esc` | Cancel |

## File Structure

```
cmd/gv/main.go              # Entry point
internal/
  git/
    worktree.go             # Worktree discovery
    diff.go                 # Diff computation
    commits.go              # Commit listing
  ui/
    model.go                # Root bubble tea model
    diff_view.go            # Main diff view
    commit_filter.go        # Commit filter popup
    worktree_switcher.go    # Fuzzy finder
    worktree_list.go        # Full list view
    styles.go               # Lip gloss styles
  syntax/
    highlight.go            # Chroma wrapper
go.mod
go.sum
```

## Implementation Notes

- Use go-git types directly where possible (plumbing.Hash, object.Commit, etc.)
- Worktree discovery via `git worktree list --porcelain` (go-git doesn't support worktree listing)
- Main branch detection: check for origin/main, fall back to origin/master
- Diff parsing: use go-git's diff utilities
- Syntax detection: Chroma's lexers.Match() by filename
